<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Dynamic Graph Page Switcher</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            margin: 2em;
        }

        button {
            margin: 0.5em;
            padding: 0.5em 1em;
            font-size: 1em;
        }

        .page {
            display: none;
        }

        .active {
            display: block;
        }

        h1 {
            color: #333;
        }

        #mermaid-graph {
            margin: 2em auto;
            border: 1px solid #ccc;
            padding: 1em;
            max-width: 600px;
            background: #f9f9f9;
        }

        #breadcrumbs {
            font-size: 0.9em;
            color: #555;
            margin: 1em 0;
        }
    </style>
</head>
<body>

    <h1 id="txt-title" data-testid="txt-title">This is Page A</h1>

    <div id="breadcrumbs">Navigation history: <span id="breadcrumb-path">PageA</span></div>

    <div id="navigation"></div>

    <div id="mermaid-graph" class="mermaid"></div>

    <div id="pages-container"></div>

    <script>
        function getMermaidGraphFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const raw = params.get('graph');
            if (raw) return decodeURIComponent(raw);
            return `        
                PageA->>PageB
                PageA->>PageC
                PageA->>PageD
                PageA->>PageE

                PageB->>PageA
                PageB->>PageC
                PageB->>PageD
                PageB->>PageE

                PageC->>PageA
                PageC->>PageB
                PageC->>PageD
                PageC->>PageE

                PageD->>PageA
                PageD->>PageB
                PageD->>PageC
                PageD->>PageE

                PageE->>PageA
                PageE->>PageB
                PageE->>PageC
                PageE->>PageD
              `.trim();
        }

        function normalizeMermaidFlowchart(graph) {
            // Replace any `->>` with `-->` for flowchart compatibility
            return graph.replace(/->>/g, '-->');
        }

        function parseMermaidEdges(mermaid) {
            const edges = [];
            const lines = mermaid.split('\n');
            for (const line of lines) {
                const match = line.trim().match(/^(\w+)\s*-->\s*(\w+)/);
                if (match) {
                    const [, from, to] = match;
                    edges.push({ from, to });
                }
            }
            return edges;
        }

        function buildGraph(edges) {
            const graph = {};
            for (const { from, to } of edges) {
                if (!graph[from]) graph[from] = [];
                graph[from].push(to);
                if (!graph[to]) graph[to] = [];
            }
            return graph;
        }

        function renderMermaid(graphText) {
            const mermaidDiv = document.getElementById("mermaid-graph");
            mermaidDiv.textContent = `graph TD\n${graphText}`;
            mermaid.run();
        }

        function initPages(graph, startNode = "PageA") {
            const container = document.getElementById("pages-container");
            const nav = document.getElementById("navigation");
            const breadcrumbs = document.getElementById("breadcrumb-path");
            const title = document.getElementById("txt-title");

            const visited = [];

            Object.keys(graph).forEach(pageId => {
                const div = document.createElement("div");
                div.id = pageId;
                div.className = "page";
                div.textContent = `Content for ${pageId}`;
                container.appendChild(div);
            });

            function updateBreadcrumbs() {
                breadcrumbs.textContent = visited.join(" â†’ ");
            }

            function updateHistory(page) {
                history.pushState({ page }, "", `#${page}`);
            }

            function showPage(id, skipPush = false) {
                if (!graph[id]) return;

                Object.keys(graph).forEach(pageId => {
                    document.getElementById(pageId).classList.toggle("active", pageId === id);
                });

                title.textContent = `This is ${id}`;

                if (!visited.length || visited[visited.length - 1] !== id) {
                    visited.push(id);
                    updateBreadcrumbs();
                }

                nav.innerHTML = "";
                (graph[id] || []).forEach(target => {
                    const btn = document.createElement("button");
                    btn.textContent = `Go to ${target}`;
                    btn.dataset.testid = `btn-${target}`;
                    btn.disabled = target === id;
                    btn.onclick = () => {
                        showPage(target);
                        updateHistory(target);
                    };
                    nav.appendChild(btn);
                });

                if (!skipPush) updateHistory(id);
            }

            window.onpopstate = (e) => {
                const page = (e.state && e.state.page) || startNode;
                showPage(page, true);
            };

            const hash = window.location.hash?.substring(1);
            showPage(graph[hash] ? hash : startNode);
        }

        const rawGraph = getMermaidGraphFromUrl();
        const flowchart = normalizeMermaidFlowchart(rawGraph);
        const edges = parseMermaidEdges(flowchart);
        const graph = buildGraph(edges);

        renderMermaid(flowchart);
        initPages(graph);
    </script>

</body>
</html>
